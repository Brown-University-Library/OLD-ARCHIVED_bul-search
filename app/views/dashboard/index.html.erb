<style>
    table {
        border-collapse: collapse;
        border: 1px solid #ecf0ea;
    }

    table th {
        border: 1px solid #ecf0ea;
        padding-left: 10px;
        padding-right: 10px;
    }

    table td {
        border: 1px solid #ecf0ea;
        padding-left: 10px;
        padding-right: 10px;
    }

    h3 {
        font-size: 20px;
    }

    .number_cell_fixed {
        text-align: right;
        vertical-align: bottom;
        width: 100px;
    }
</style>

<div class="row">
    <h2>Collection Ecosystem Dashboard
        <div style="float: right;align:right">
            <a href="<%= @new_dashboard_url %>"
                type="button"
                title="Create a new definition"
                class="btn btn-default">
                <span class="glyphicon glyphicon-file"></span> New
            </a>
        </div>
    </h2>

    <div class="col-sm-12">
        <div id="filters">
            <span>
                Owner:
                <select name="filterUser" id="filterUser">
                    <% @owners.each do |owner| %>
                        <option value="<%= owner[:id] %>"><%= owner[:text] %></option>
                    <% end %>
                </select>
            </span>
            <span>
                Name: <input type="text" name="filterName" id="filterName" placeholder="search by name"></input>
            </span>
        </div>

        <table>
            <tr>
                <th>Type</th>
                <th>Owner</th>
                <th>Name</th>
                <th>Status</th>
                <th class="number_cell_fixed">Bib Records</th>
            </tr>
            <% @summaries.each do |summary| %>
                <tr class="data-row row-owner-<%= summary.owner_id %>">
                    <td><%= summary.public == 1 ? "Public" : "Private" %></td>
                    <td><%= summary.owner_display %></td>
                    <td><a href="<%= dashboard_show_url(summary.id) %>"><%= summary.list_full_name %></a></td>
                    <td>
                        <span title="<%= summary.status_tooltip %>" class="<%= summary.status_icon %>"></span>
                    </td>
                    <td class="number_cell_fixed">
                        <% if summary.status == "OK" %>
                            <%= number_with_delimiter(summary.bib_count) %>
                        <% end %>
                    </td>
                </tr>
            <% end %>
        </table>
    </div>
</div>


<div class="row">
    <% if @editors.count > 0 %>
        <h3>Users with edit access</h3>
        <p>Public collections can be viewed by any patron,
        but only the following users can edit them.</p>

        <!-- <p>Private collections are only visible and editable by their owner.</p> -->

        <div class="col-sm-12">
            <table>
                <tr>
                    <th>User</th>
                </tr>
                <% @editors.each do |user| %>
                    <tr>
                        <td><%= user %></td>
                    </tr>
                <% end %>
            </table>
        </div>
    <% end %>
</div>

<script>
$(document).ready(function(){
    var filterRows = function() {
        // Get the values to filter by
        var filterOwner = $("#filterUser").val().trim().toLowerCase();
        var filterName = $("#filterName").val().trim().toLowerCase();

        // No filter, make all rows visible.
        if ((filterOwner == "_all_") && (filterName == "")) {
            $(".data-row").removeClass("hidden");
            return;
        }

        var isFilterByOwner = (filterOwner != "_all_") && (filterName == "");
        var isFilterByName = (filterOwner == "_all_") && (filterName != "");
        var isFilterByBoth = (filterOwner != "_all_") && (filterName != "");

        // Process all rows and filters them
        $(".data-row").each(function(i, tr) {

            // Get the values of this row (owner and collection name)
            var i;
            var cssClasses = $(tr).attr("class").split(/\s+/);
            var rowOwner = "";
            for(i = 0; i < cssClasses.length; i++) {
                if (cssClasses[i].startsWith("row-owner-")) {
                    rowOwner = cssClasses[i].replace("row-owner-", "").toLowerCase();
                    break;
                }
            }
            var rowName = $(tr).children().first().next().next().text().toLowerCase();

            if (isFilterByOwner) {
                if (filterOwner == rowOwner) {
                    $(tr).removeClass("hidden");
                } else {
                    $(tr).addClass("hidden");
                }
                return;
            }

            if (isFilterByName) {
                if (rowName.includes(filterName)) {
                    $(tr).removeClass("hidden");
                } else {
                    $(tr).addClass("hidden");
                }
                return;
            }

            if (isFilterByBoth) {
                if ((filterOwner == rowOwner) && (rowName.includes(filterName))) {
                    $(tr).removeClass("hidden");
                } else {
                    $(tr).addClass("hidden");
                }
                return;
            }
        });
    }

    // Filter on owner change
    $("#filterUser").change(function() {
        filterRows();
    });

    // Filter on collection name change
    $("#filterName").on("input",function(e) {
        filterRows();
    });

    // Apply filter with values on screen on load
    filterRows();
});
</script>
<div id="content" class="col-md-9 show-document">

  <%= render 'previous_next_doc' %>

<% @page_title = t('blacklight.search.show.title', :document_title => document_show_html_title, :application_name => application_name).html_safe -%>
<% content_for(:head) { render_link_rel_alternates } -%>
<%# this should be in a partial -%>

<div id="document" class="document <%= render_document_class %>" itemscope  itemtype="<%= @document.itemtype %>">

  <script type="text/javascript">

    $(document).ready(
      function(){
        bib_id = getBibId();
        api_url = "http://library.brown.edu/services/availability/id/" + bib_id + "/?callback=?";
        $.getJSON( api_url, addStatus );
      }
    );

    function getBibId() {
      /* Pulls bib_id from DOM.
       * Called on doc.ready */
      bib_id_div_name = $( "div[id^='doc_']" )[0].id;
      bib_id_start = bib_id_div_name.search( '_' ) + 1;
      bib_id = bib_id_div_name.substring( bib_id_start );
      return bib_id;
    }

    function addStatus( json_output ) {
      /* Parses api data & updates DOM.
       * Called on doc.ready */
      $("#availability").append( '<pre>' + JSON.stringify(json_output, null, 2) + '</pre>' )
    }

  </script>

  <!--
    <script type="text/javascript">

    $(document).ready(
      function(){
        var bib_id = getBibId();
        // alert( bib_id );
        var api_url = "http://library.brown.edu/services/availability/id/" + bib_id + "/?callback=?";
        $.getJSON( api_url, addStatus );
      }
    );

    function getBibId() {
      /* Pulls bib_id from DOM.
       * Called on doc.ready */
      bib_id_div_name = $( "div[id^='doc_']" )[0].id;
      bib_id_start = bib_id_div_name.search( '_' ) + 1;
      bib_id = bib_id_div_name.substring( bib_id_start );
      return bib_id;
    }

    function addStatus( json_output ) {
      /* Hits availability API & updates DOM.
       * Called on doc.ready */
      // alert( "in addStatus" );
      // alert( JSON.stringify(json_output) );
      // var availability = checkAvailability( json_output );
      // alert( "and availability is: `" + availability + "`" );
      // $("#availability").append( availability );
      $("#availability").append( '<pre>' + JSON.stringify(json_output, null, 2) + '</pre>' )
    }

    function checkAvailability( json_output ) {
      /* Parses api info.
       * Called by addStatus() */
      // alert( "in checkAvailability" );
      var items = json_output.items;
      if ( items.length == 0 ) {
        item_status = "UKNOWN";
      } else {
        items.forEach( setAvailability );
      }
      return "<p>::: availability - " + item_status + " :::</p>";
    }

    function setAvailability( item ) {
      /* Examines individual item.
       * Called by checkAvailability() iteration. */
      if ( item.availability == "AVAILABLE" ) {
        item_status = "AVAILABLE";
      }
    }

  </script>
  -->

  <div id="doc_<%= @document.id.to_s.parameterize %>">

    <% # bookmark/folder functions -%>
    <%= render_document_partials @document, blacklight_config.view_config(:show).partials %>

  </div>
  <div id="availability"></div>

</div>



  <% if @document.respond_to?(:export_as_openurl_ctx_kev) %>
    <!--
         // COinS, for Zotero among others.
         // This document_partial_name(@document) business is not quite right,
         // but has been there for a while.
    -->
    <span class="Z3988" title="<%= @document.export_as_openurl_ctx_kev(document_partial_name(@document)) %>"></span>
  <% end %>

</div>

<div id="sidebar" class="col-md-3">
   <%= render_document_sidebar_partial %>
</div>
